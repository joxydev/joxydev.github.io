<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto Tracker — JoxyDev Demo</title>
  <link rel="stylesheet" href="theme.css">
</head>
<body>
  <script src="theme.js"></script>
  <div class="lang-switch">
    <button class="lang-btn" data-lang="en">EN</button>
    <button class="lang-btn active" data-lang="ru">RU</button>
    <button class="lang-btn" data-lang="ro">RO</button>
  </div>
  <div class="wrap">
    <header style="margin-bottom:14px"><a href="index.html" data-i18n="back">← Back</a><h1 data-i18n="crypto_title">Crypto Tracker (Demo)</h1>
      <p class="muted">Fetch current prices from CoinGecko and store time-series in localStorage. No API key required.</p>
    </header>

    <div class="card">
      <div class="row">
        <label for="coin">Coin:</label>
        <select id="coin">
          <option value="bitcoin">Bitcoin (BTC)</option>
          <option value="ethereum">Ethereum (ETH)</option>
          <option value="litecoin">Litecoin (LTC)</option>
          <option value="dogecoin">Dogecoin (DOGE)</option>
        </select>
        <button id="fetchBtn" data-i18n="fetch_now">Fetch Now</button>
        <button id="clearBtn" data-i18n="clear_history">Clear History</button>
        <label style="margin-left:8px;color:var(--muted)"><input id="auto" type="checkbox" /> Auto</label>
        <input id="intv" type="number" value="10" min="1" style="width:72px" />s
      </div>

      <div>
        <small style="color:var(--muted)">Latest:</small>
        <div id="latest" style="padding:8px 0;color:var(--text)">No data yet.</div>
        <canvas id="chart"></canvas>
        <table aria-live="polite"><thead><tr><th>Time</th><th>Price (USD)</th></tr></thead><tbody id="hist"></tbody></table>
      </div>
    </div>
  </div>

  <script src="translations.js"></script>
  <script>
    const coinSel = document.getElementById('coin');
    const fetchBtn = document.getElementById('fetchBtn');
    const latest = document.getElementById('latest');
    const histTbody = document.getElementById('hist');
    const clearBtn = document.getElementById('clearBtn');
    const auto = document.getElementById('auto');
    const intv = document.getElementById('intv');
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    let timer = null;

    function storageKey(coin){ return 'joxy_crypto_' + coin }

    function loadHistory(coin){
      try { return JSON.parse(localStorage.getItem(storageKey(coin)) || '[]'); } catch(e){ return []; }
    }

    function saveHistory(coin, arr){ localStorage.setItem(storageKey(coin), JSON.stringify(arr.slice(-50))); }

    async function fetchPrice(coin){
      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${coin}&vs_currencies=usd`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(res.statusText);
      const data = await res.json();
      return data[coin].usd;
    }

    function render(){
      const coin = coinSel.value;
      const hist = loadHistory(coin);
      histTbody.innerHTML = '';
      hist.slice().reverse().forEach(item => {
        const tr = document.createElement('tr');
        const t = new Date(item.t).toLocaleTimeString();
        tr.innerHTML = `<td>${t}</td><td>${item.p.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:8})}</td>`;
        histTbody.appendChild(tr);
      });
      if (hist.length){
        const last = hist[hist.length-1];
        latest.textContent = `${coinSel.options[coinSel.selectedIndex].text}: $${last.p}`;
      } else {
        latest.textContent = 'No data yet.';
      }
      drawChart(hist.map(h=>h.p));
    }

    function drawChart(values){
      const dpr = window.devicePixelRatio || 1;
      const w = canvas.clientWidth; const h = canvas.clientHeight;
      canvas.width = w * dpr; canvas.height = h * dpr;
      ctx.scale(dpr,dpr);
      ctx.clearRect(0,0,w,h);
      if (!values || values.length===0) return;
      const max = Math.max(...values); const min = Math.min(...values);
      const range = max - min || 1;
      ctx.strokeStyle = '#4da3ff'; ctx.lineWidth=2; ctx.beginPath();
      values.forEach((v,i)=>{
        const x = (i/(values.length-1)) * (w-10) + 5;
        const y = h - 10 - ((v-min)/range)*(h-20);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    async function doFetch(){
      const coin = coinSel.value;
      try {
        const p = await fetchPrice(coin);
        const hist = loadHistory(coin);
        hist.push({t: Date.now(), p});
        saveHistory(coin, hist);
        render();
      } catch(err){
        latest.textContent = 'Fetch error: ' + err.message;
      }
    }

    fetchBtn.addEventListener('click', doFetch);
    clearBtn.addEventListener('click', ()=>{ localStorage.removeItem(storageKey(coinSel.value)); render(); });
    coinSel.addEventListener('change', render);
    auto.addEventListener('change', ()=>{
      if (auto.checked){
        doFetch();
        timer = setInterval(doFetch, Math.max(1,Number(intv.value)||10)*1000);
      } else { clearInterval(timer); timer = null; }
    });

    // initial render
    window.addEventListener('load', render);
    window.addEventListener('resize', ()=> drawChart(loadHistory(coinSel.value).map(h=>h.p)));
  </script>
</body>
</html>
